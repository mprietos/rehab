generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  DOCTOR
  PATIENT
}

enum PlantStage {
  SEED
  SPROUT
  PLANT
  FLOWER
}

enum TaskType {
  MEDICATION
  ACTIVITY
  EMOTION_CHECK
}

enum MoodLevel {
  GOOD      // Bien
  NEUTRAL   // Regular
  BAD       // Mal
}

model Clinic {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  address   String?  @db.VarChar(255)
  phone     String?  @db.VarChar(50)
  email     String?  @db.VarChar(255)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  users     User[]

  @@map("clinics")
}

model User {
  id                    String          @id @default(uuid()) @db.Uuid
  email                 String          @unique @db.VarChar(255)
  password              String          @db.VarChar(255)
  firstName             String          @map("first_name") @db.VarChar(255)
  lastName              String          @map("last_name") @db.VarChar(255)
  role                  UserRole        @default(PATIENT)
  encryptionKey         String          @map("encryption_key") @db.VarChar(255)
  isActive              Boolean         @default(true) @map("is_active")
  clinicId              String?         @map("clinic_id") @db.Uuid
  emergencyContactName  String?         @map("emergency_contact_name") @db.VarChar(255)
  emergencyContactPhone String?         @map("emergency_contact_phone") @db.VarChar(50)
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")

  clinic           Clinic?         @relation(fields: [clinicId], references: [id])
  gardenState      GardenState?
  dailyTasks       DailyTask[]
  moodChecks       MoodCheck[]

  // Relations for Doctor-Patient
  // Users who are patients of this doctor
  patientsAsDoctor DoctorPatient[] @relation("DoctorToPatient")
  // Users who are doctors of this patient
  doctorsAsPatient DoctorPatient[] @relation("PatientToDoctor")

  // Messages
  sentMessages     Message[]       @relation("SentMessages")
  receivedMessages Message[]       @relation("ReceivedMessages")

  @@map("users")
}

model GardenState {
  id                  String     @id @default(uuid()) @db.Uuid
  userId              String     @unique @map("user_id") @db.Uuid
  plantStage          PlantStage @default(SEED) @map("plant_stage")
  currentXp           Int        @default(0) @map("current_xp")
  streakDays          Int        @default(0) @map("streak_days")
  lastActionDate      DateTime?  @map("last_action_date") @db.Date
  totalTasksCompleted Int        @default(0) @map("total_tasks_completed")
  isActive            Boolean    @default(true) @map("is_active")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("garden_states")
}

model DailyTask {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  description String    @db.VarChar(255)
  type        TaskType
  date        DateTime  @default(now()) @db.Date
  isCompleted Boolean   @default(false) @map("is_completed")
  completedAt DateTime? @map("completed_at")
  notes       String?   @db.Text
  mood        String?   @db.VarChar(20)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@index([userId, date])
  @@map("daily_tasks")
}

model DoctorPatient {
  doctorId   String   @map("doctor_id") @db.Uuid
  patientId  String   @map("patient_id") @db.Uuid
  assignedAt DateTime @default(now()) @map("assigned_at")
  isActive   Boolean  @default(true) @map("is_active")

  doctor  User @relation("DoctorToPatient", fields: [doctorId], references: [id], onDelete: Cascade)
  patient User @relation("PatientToDoctor", fields: [patientId], references: [id], onDelete: Cascade)

  @@id([doctorId, patientId])
  @@map("doctor_patients")
}

model Message {
  id        String   @id @default(uuid()) @db.Uuid
  content   String   @db.Text
  fromId    String   @map("from_id") @db.Uuid
  toId      String   @map("to_id") @db.Uuid
  isRead    Boolean  @default(false) @map("is_read")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sender   User @relation("SentMessages", fields: [fromId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [toId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model MoodCheck {
  id                       String    @id @default(uuid()) @db.Uuid
  userId                   String    @map("user_id") @db.Uuid
  date                     DateTime  @default(now()) @db.Date
  moodLevel                MoodLevel @map("mood_level")
  notes                    String?   @db.Text
  requestedEmergencyCall   Boolean   @default(false) @map("requested_emergency_call")
  emergencyCallNotified    Boolean   @default(false) @map("emergency_call_notified")
  doctorNotified           Boolean   @default(false) @map("doctor_notified")
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("mood_checks")
}
